# Code for test poincare maps

import numpy as np

import pytest


# Test for poincare odeint map
def test_lorenz_maps(lorenz):
    sigma = 10
    rho = 166.04
    beta = 8 / 3
    par = [sigma, rho, beta]  # Parameters
    x0 = [2, -1, 150]  # Initials conditions
    lor = lorenz.poincare(x0, par, 500, 5)
    assert lor.x[:, -1] == pytest.approx(
        [11.8579, -9.1806, 159.9543], rel=1e-3
    )


# Test for check trajectories table
def test_lorenz_table(time_evolution_fun):
    y0 = [0.5]
    tdesc = 20.0
    tf = 10
    par = 0
    n = 1000
    states = time_evolution_fun.poincare(y0, par, tdesc, tf, n)
    table = states.to_table()
    assert np.all(table.columns[0] == "t")


# Test for poincare  fit function
def test_fit(lorenz):
    sigma = 10
    rho = 166.04
    beta = 8 / 3
    par = [sigma, rho, beta]  # Parameters
    x0 = [2, -1, 150]  # Initials conditions
    lor = lorenz.poincare(x0, par, 500, 40)
    tc, mp, y12 = lor._fit(0, 1, 2, 2)
    tc_expected = np.array(
        [
            0.2680268,
            1.40014001,
            2.53625363,
            3.66836684,
            4.80048005,
            5.93259326,
            7.06470647,
            8.19681968,
            9.33293329,
            10.4650465,
            11.59715972,
            12.72927293,
            13.86138614,
            14.99749975,
            16.12961296,
            17.26172617,
            18.39383938,
            19.5259526,
            20.65806581,
            21.79417942,
            22.92629263,
            24.05840584,
            25.19051905,
            26.32263226,
            27.45874587,
            28.59085909,
            29.7229723,
            30.85508551,
            31.98719872,
            33.11931193,
            34.25542554,
            35.38753875,
            36.51965197,
            37.65176518,
            38.78387839,
            39.919992,
        ]
    )
    mp_expected = np.array(
        [
            [
                0.0,
                41.28472937,
                41.28540907,
                41.28580979,
                41.28475662,
                41.28435775,
                41.28449158,
                41.28502217,
                41.28580015,
                41.28521993,
                41.28449233,
                41.28436301,
                41.28470344,
                41.28537118,
                41.28587911,
                41.28479152,
                41.28436373,
                41.28447485,
                41.28498962,
                41.28575927,
                41.28527224,
                41.28451274,
                41.28435737,
                41.28467829,
                41.28533369,
                41.28595022,
                41.28482797,
                41.28437098,
                41.28445907,
                41.28495765,
                41.28571861,
                41.28532622,
                41.28453457,
                41.28435285,
                41.28465391,
                41.28529662,
            ],
            [
                0.0,
                41.28540907,
                41.28580979,
                41.28475662,
                41.28435775,
                41.28449158,
                41.28502217,
                41.28580015,
                41.28521993,
                41.28449233,
                41.28436301,
                41.28470344,
                41.28537118,
                41.28587911,
                41.28479152,
                41.28436373,
                41.28447485,
                41.28498962,
                41.28575927,
                41.28527224,
                41.28451274,
                41.28435737,
                41.28467829,
                41.28533369,
                41.28595022,
                41.28482797,
                41.28437098,
                41.28445907,
                41.28495765,
                41.28571861,
                41.28532622,
                41.28453457,
                41.28435285,
                41.28465391,
                41.28529662,
                41.28602313,
            ],
        ]
    )
    y12_expected = np.array(
        [
            41.28472937,
            41.28540907,
            41.28580979,
            41.28475662,
            41.28435775,
            41.28449158,
            41.28502217,
            41.28580015,
            41.28521993,
            41.28449233,
            41.28436301,
            41.28470344,
            41.28537118,
            41.28587911,
            41.28479152,
            41.28436373,
            41.28447485,
            41.28498962,
            41.28575927,
            41.28527224,
            41.28451274,
            41.28435737,
            41.28467829,
            41.28533369,
            41.28595022,
            41.28482797,
            41.28437098,
            41.28445907,
            41.28495765,
            41.28571861,
            41.28532622,
            41.28453457,
            41.28435285,
            41.28465391,
            41.28529662,
            41.28602313,
        ]
    )
    assert np.all((tc_expected - tc) < 1e-4)
    assert np.all((mp_expected - mp) < 1e-4)
    assert np.all((y12_expected - y12) < 1e-4)
